<html>

<head>
  <title>Welcome to Auction</title>

  <link rel="stylesheet" href="/styles/style.css">

  <!-- Firebase CDNs -->
  <script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-database.js"></script>

  <!-- Firebase CDNs END -->

  <!-- Bootstrap , jQuery , SocketIO & Momentjs CDNs -->

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/countdown/2.6.0/countdown.js"></script>


  <!-- Bootstrap , jQuery , SocketIO & Momentjs CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>


</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">E-auction</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">

        <li class="nav-item">
          <button id="btnn" class="btn btn-outline-primary my-2 my-sm-0" data-toggle="modal" data-target="#addpro">Add
            Product</button>
          <button id="btnn" class="btn btn-outline-primary my-2 my-sm-0" data-toggle="modal"
            data-target="#addbidder">Add Bidder</button>

        </li>

        </li>

      </ul>
      <form class="form-inline my-2 my-lg-0">
        <a class="nav-link disabled" href="#" id="userName"> </a>
        <button class="btn btn-outline-danger my-2 my-sm-0" type="button" onclick="logout();">Logout</button>

      </form>
    </div>
  </nav>

  </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="addpro" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Add Product Details</h4>

          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">


          <form id="add_product_form">

            <input type="text" class="form-control" placeholder="Product ID" id="pcode" required /><br>
            <input type="text" class="form-control" placeholder="Name" id="naam" required /><br>
            <input type="text" class="form-control" placeholder="Quantity" id="quan" required /><br>
            <input type="text" class="form-control" placeholder="Description" id="deescription" required /><br>
            <input type="text" class="form-control" placeholder="Start Bid" id="sttartbid" required /> <br> <br>
            Start Date & Time : <input type="datetime" class="form-control" placeholder="YYYY/MM/DD H:mm" id="sdatetime"
              required />
            <br>
            End Date & Time : <input type="datetime" class="form-control" placeholder="YYYY/MM/DD H:mm" id="edatetime"
              required />
            <br> <br>

        </div>
        <div class="modal-footer">
          <input class="btn btn-primary" type="button" value="Submit" onclick="AddProduct();"></input>
          </form>
          <button type="button" class="btn btn-default" data-dismiss="modal"
            onclick="document.getElementById('add_product_form').reset()">Close</button>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="addbidder" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Add Bidder Details</h4>

          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">


          <form id="add_bidder_form">

            <input type="text" class="form-control" placeholder="User ID" id="userID" required /><br>
            <input type="email" class="form-control" placeholder="Email ID" id="emailID" required /><br>
            <input type="text" class="form-control" placeholder="Username" id="user_Name" required /><br>
            <!-- <input type="hidden" required id="access" value="b" />
            <input type="hidden" required id="user_password" value="0192023a7bbd73250516f069df18b500" /> -->

            <br>

          </form>
        </div>
        <div class="modal-footer">
          <input class="btn btn-primary" type="button" value="Add" onclick="AddBidder();" />
          <button type="button" class="btn btn-default" data-dismiss="modal"
            onclick="document.getElementById('add_bidder_form').reset()">Close</button>
        </div>
      </div>

    </div>
  </div>

  <div id="auctions">

  </div>

  <!-- MODAL Start -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" style="float: left">Bid Log</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>

        </div>
        <div class="modal-body">
          <div id="logTable">
            <h7 style="float: left ; margin-left: 30px">Timestamp</h7>
            <h7 style="float: right ; margin-right: 70px; ">Bid</h7>
            <h7 style="float: right; margin-right: 80px;">Bidder</h7>
          </div>
        </div>
        <!-- Modal content END-->
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>

    </div>
  </div>
  <!-- MODAL END -->


  <!-- Included Scripts -->

  <script src="../../scripts/script.js"></script>
  <script>

    var socket = io.connect('http://localhost:12251', {
      transports: ['websocket'],
      query: {
        token: getLoggedUserDetails().token
      }
    });

    var auctions_data = [];
    var data_added = false;

    socket.on('connect', () => {
      //  console.log(socket.connected); // true
      socket.emit('getAuctionsAdmin', ({ isCalled: true, token: getLoggedUserDetails().token }));

    });

    socket.on('getAuctionsAdminCallback', (response) => {


      if (response.status) {

        auctions_data = response.value;

        if (!data_added) {

          $('#productTableB tr').remove();

          var fragment = document.createDocumentFragment();
          var table = document.createElement("table");
          table.id = 'productTableB';
          thead = document.createElement("thead");
          thead.innerHTML = '<tr>' +
            '<th>Remaining Time</th>' +
            '<th>Products</th>' +
            '<th>Description</th>' +
            '<th>Start-Bid</th>' +
            '<th>Current-Bid</th>' +
            '<th>Lowest Bidder ID</th>' +
            '</tr>';

          table.appendChild(thead);


          $.each(auctions_data.auctions, function (i, item) {
            var start_ts = moment.unix(auctions_data.time_stamp);
            var end_ts = moment(item.edate, "YYYY/MM/DD H:mm:ss");
            var duration = moment.duration(end_ts.diff(start_ts));
            var remainT = dhm(duration.asMilliseconds());
            var proName = item.name;
            var stBid = item.startbid;
            var crBid = item.currbid;
            var pcodee = item.pcode;
            var quantity = item.quantity;
            var descr = item.description;
            var bidderID = item.user_id;



            tr = document.createElement("tr");
            td1 = document.createElement("td");
            td2 = document.createElement("td");
            td3 = document.createElement("td");
            space = document.createElement("td");
            td4 = document.createElement("td");
            td5 = document.createElement("td");
            td6 = document.createElement("td");

            td1.innerHTML = '<span class="badge badge-danger"  id="time_' + i + '">' + remainT + '</span>';
            space.innerHTML = '<div>' + proName + '&nbsp;&nbsp;' + '<span style="color:red; font:bold 30px">' + '(' + quantity + ')' + '</span>' + '&nbsp;&nbsp;&nbsp;&nbsp;' + '<button class="btn btn-outline-info btn-sm" id="bidlog_' + pcodee + '" type="button" onclick = "showAlog(' + pcodee + ');">' + 'Bid Log' + '</button>' + '</div>' +'<div>'+ 'Active: ' +'<span class="text-muted" id="bidderStatus_' + pcodee + '">' + '</span>' + '</div>';
            td5.innerHTML = descr;
            td3.innerHTML = stBid
            td2.innerHTML = '<span id = "cuurbid_' + pcodee + '">' + crBid + '</span><input type="hidden" id="pcode_' + pcodee + '" value="' + pcodee + '"/>';
            td6.innerHTML = bidderID;

            tr.appendChild(td1);
            tr.appendChild(space);
            tr.appendChild(td5);
            tr.appendChild(td3);
            tr.appendChild(td2);
            tr.appendChild(td6);
            table.appendChild(tr);
          });

          table.className = 'table table-striped';
          fragment.appendChild(table);
          document.getElementById('auctions').appendChild(fragment);

          document.getElementById('userName').innerText = 'Welcome ' + getLoggedUserDetails().user_name;

          window.setInterval(function () {
            var new_date = moment.unix(auctions_data.time_stamp).add(1, 'seconds');
            auctions_data.time_stamp = new_date.unix();

            updateData();
          }, 1000);

          data_added = true;
        }
        else {
          updateData();
        }
      }
      else {
        alert(response.message);
      }
    });

    function updateData() {
      $.each(auctions_data.auctions, function (i, item) {


        var start_ts = moment.unix(auctions_data.time_stamp);
        var end_ts = moment(item.edate, "YYYY/MM/DD H:mm:ss");
        var duration = moment.duration(end_ts.diff(start_ts));
        var remainT = dhm(duration.asMilliseconds());
        var currentBid = item.currbid;
        $("#cuurbid_" + item.pcode).html(currentBid);
        $("#time_" + i).html(remainT);
      });
    }


    function AddBidder() {
      var userID = document.getElementById('userID').value;
      var emailID = document.getElementById('emailID').value;
      var userNAME = document.getElementById('user_Name').value;

      socket.emit('addNewBidder',
        {
          bidder_id: userID,
          bidder_email: emailID,
          bidder_name: userNAME,
          token: getLoggedUserDetails().token
        });

    }

    socket.on('addNewBidderCallback', (response) => {
      Swal.fire({
        type: response.msg,
        title: response.message,
        timer: 1500
      })
    });

    socket.on('unAuthorizedCallback', (response) => {
      Swal.fire({
        title: response.message,
        position: 'top-end',
        timer: 1500
      }
      )
    });



    function AddProduct() {

      var quantity = document.getElementById('quan').value;
      var startdate = document.getElementById('sdatetime').value;
      var enddate = document.getElementById('edatetime').value;
      var productID = document.getElementById('pcode').value;
      var productName = document.getElementById('naam').value;
      var pro_desc = document.getElementById('deescription').value;
      var start_Bid = document.getElementById('sttartbid').value;


      socket.emit('addNewAuction',
        {
          productCode: productID,
          productName: productName,
          Quantity: quantity,
          Description: pro_desc,
          startBid: start_Bid,
          startTime: startdate,
          endTime: enddate,
          token: getLoggedUserDetails().token
        })

      document.getElementById('add_product_form').reset();

    }

    socket.on('addNewAuctionCallback', (response) => {
      Swal.fire({
        type: response.msg,
        title: response.message,
        timer: 1500

      })
    });

    fragmentt = document.createDocumentFragment();
    tablee = document.createElement("table");

    function showAlog(i) {
      $('#loggTTable tr').remove();
      socket.emit('bidlogForAdmin', { product_code: $('#pcode_' + i).val(), name: getLoggedUserDetails().user_name, token: getLoggedUserDetails().token });

    }

    socket.on('bidlogForAdminCallBack', (response) => {

      postAlog_data = response;
      $('#loggTTable tr').remove();

      $.each(postAlog_data.value.logs, (i, item) => {

        var Bidder = item.user_id;
        var BidAmt = item.bid_amount;
        var tstamp = item.time_stamp;
        var timeStamp = moment.unix(tstamp).format("MM/DD/YYYY H:mm")

        trow = document.createElement("tr");
        td11 = document.createElement("td");
        td22 = document.createElement("td");
        td33 = document.createElement("td");

        td11.innerHTML = timeStamp;
        td33.innerHTML = Bidder;
        td22.innerHTML = BidAmt;

        trow.appendChild(td11);
        trow.appendChild(td33);
        trow.appendChild(td22);

        tablee.appendChild(trow);

        tablee.className = 'table table-striped';

        tablee.id = 'loggTTable';
      });
      fragmentt.appendChild(tablee);
      document.getElementById('logTable').appendChild(fragmentt);
      $("#myModal").modal('show');

    });


    var activeUsers = [];
      socket.on('typing_callback', function (data) {

        if(activeUsers.length > 0) {
        for (i in activeUsers) {
          if(!(activeUsers[i].user_id == data.user_id)) {
            activeUsers.push(data);
            bidderStatus();
            return;
          }
          else {
            activeUsers[i].pcode = data.pcode;
          }

          }}
          else {
            activeUsers.push(data);
            bidderStatus();
          }
        
            console.log(activeUsers);

            setInterval(clearBidder , 2000);

            function clearBidder() {
              activeUsers = [];
              console.log('clear array');
              bidderStatus();
            }
      
    });    

              function bidderStatus() {

          $.each(activeUsers, function (i, data) {
            var status_field = document.getElementById("bidderStatus_" + data.pcode);
            if (data) {
              if(status_field.innerText == '') {
                status_field.innerText =  data.user_id ;
              }
              else if(status_field.innerText == data.user_id) {
                $("#bidderStatus_" + data.pcode).append('');
              }
              else {
                $("#bidderStatus_" + data.pcode).append( ' ,'+ data.user_id );
              }
            }
            else {
              status_field.innerHTML = '';
            }
          });
          }

    window.addEventListener("beforeunload", function () {
      console.log("Close web socket");
      socket.close();
    });

  </script>

  <!-- Included Scripts -->

</body>

</html>